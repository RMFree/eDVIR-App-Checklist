<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIESEL INSURANCE Audit Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .data-card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-extrabold text-blue-800 mb-6">DIESEL INSURANCE AUDIT RECORDS</h1>
        <div id="status-message" class="mb-4 text-center p-3 rounded-lg text-sm font-medium bg-yellow-100 text-yellow-700">Connecting to secure database...</div>
        
        <div class="data-card p-4 overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Driver ID</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vehicle ID</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Defect Notes</th>
                    </tr>
                </thead>
                <tbody id="inspection-table-body" class="bg-white divide-y divide-gray-200 text-sm">
                    <!-- Data will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Firebase Imports and Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, limit, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Variables
        const appId = 'eDVIR-App-Checklist';
        const statusMessage = document.getElementById('status-message');

     // --- CRITICAL: PASTE YOUR FIREBASE CONFIGURATION HERE ---
const firebaseConfig = {
apiKey: "AIzaSyCWNSHd6957sh7XWrEZieVYX-a1J4KObAs",
  authDomain: "edvir-tablet-app.firebaseapp.com",
  projectId: "edvir-tablet-app",
  storageBucket: "edvir-tablet-app.firebasestorage.app",
  messagingSenderId: "189931329843",
  appId: "1:189931329843:web:78d9884d4c47c0de384646"
};
// --------------------------------------------------------

        let db, auth, userId = null;

        function updateStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = `mb-4 text-center p-3 rounded-lg text-sm font-medium ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
        }

        async function initializeDashboard() {
            try {
                if (!firebaseConfig.projectId) {
                    throw new Error("Missing Firebase Config. Please insert keys.");
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in anonymously to meet security rules
                await signInAnonymously(auth);
                userId = auth.currentUser.uid;
                updateStatus("Connected. Loading audit records...", 'success');
                
                loadInspections();

            } catch (error) {
                console.error("Dashboard Initialization Error:", error);
                updateStatus(`Error connecting: ${error.message}`, 'error');
            }
        }

        function loadInspections() {
            const collectionPath = `artifacts/${appId}/public/data/inspections`;
            
            // Query: Get last 50 inspections, ordered by most recent (timestamp).
            // NOTE: orderBy is used here, which might require an index in Firebase. If it errors, remove `orderBy` and sort in JS.
         const q = collection(db, collectionPath);
            
            onSnapshot(q, (snapshot) => {
                const tableBody = document.getElementById('inspection-table-body');
                tableBody.innerHTML = '';
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const row = tableBody.insertRow();
                    
                    const statusClass = data.overallStatus === 'Defect' ? 'bg-red-50 text-red-700 font-semibold' : 'text-gray-900';
                    const defectNotes = data.defectNotes || 'â€”';
                    const time = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString() : 'N/A';
                    const vehicleId = data.vehicleId || 'N/A'; // Capture the new field if present

                    row.className = statusClass;
                    
                    row.insertCell().textContent = time;
                    row.insertCell().textContent = data.driverSignature || (data.userId ? data.userId.substring(0, 8) + '...' : 'Unknown');
                    row.insertCell().textContent = vehicleId;
                    row.insertCell().textContent = data.overallStatus;
                    row.insertCell().textContent = defectNotes;
                });
            }, (error) => {
                console.error("Error retrieving data:", error);
                updateStatus(`Error retrieving records: ${error.message}`, 'error');
            });
        }

        // Initialize on window load
        window.onload = function() {
            initializeDashboard();
        };
    </script>
</body>
</html>




